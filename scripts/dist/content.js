!function(){var e=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function c(e){try{d(o.next(e))}catch(t){i(t)}}function s(e){try{d(o.throw(e))}catch(t){i(t)}}function d(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}d((o=o.apply(e,t||[])).next())}))};Object.defineProperty({},"__esModule",{value:!0});const t=window.wrappedJSObject;function n(){var e;console.debug("injected load");const t={protocolVersion:3},n=window,o=n.mqtt,r=null===(e=document.cookie.match(/c_user=(\d+)/))||void 0===e?void 0:e[1];function i(e,t){const n=[];for(n.push(e);n.length>0;){let e=n.pop();if(Array.isArray(e)){if(e.includes(t))return e;n.push(...e.slice().reverse())}else if(e===Object(e)){if(Object.keys(e).includes(t))return e[t];n.push(...Object.values(e).reverse())}}return null}function c(e,t=!1){const n=[...Array.from(document.querySelectorAll('script[type="application/json"]'))].filter(t=>{var n;return null===(n=t.textContent)||void 0===n?void 0:n.includes(e)}).map(e=>{var t;return JSON.parse(null!==(t=e.textContent)&&void 0!==t?t:"{}")});return t?n.map(t=>i(t,e)):i(n,e)}WebSocket=new Proxy(WebSocket,{construct(e,c,s){const d=Reflect.construct(e,c,s);return console.debug("new socket created",d),d.addEventListener("message",e=>{if(!n.cfg.fakeMessageNotification||!d.url.includes("edge-chat")||void 0!==typeof document.hidden&&!document.hidden)return;const c=o.parser(t);c.on("packet",e=>{if("publish"==e.cmd&&"/ls_resp"==e.topic){const t=(new TextDecoder).decode(e.payload),o=JSON.parse(t);if(!o.sp)return;if(o.sp.includes("updateThreadSnippet")){const e=i(JSON.parse(o.payload).step,"updateThreadSnippet");if(!e||e[5][1]==r)return;const t={cid:e[2][1],uid:e[5][1],msg:e[3]},c=n.users[t.uid],s=n.groups?n.groups[t.cid]:function(e){var t;if(n.users[e])return null;const o=document.querySelector(`a[href="/messages/t/${e}/"]`),r=null===(t=null==o?void 0:o.querySelector("span:nth-child(1) > span:nth-child(1)"))||void 0===t?void 0:t.innerText,i=null==o?void 0:o.querySelectorAll("img");return{cid:e,name:r,img:i&&i.length>1?null:(null==i?void 0:i[0])?i[0].src:null}}(t.cid),d="Facebook: "+(s?c.name+" to "+s.name:c.name);new Notification(d,{icon:s?s.img:c.profile_picture.uri,body:t.msg})}}}),c.on("error",e=>{e.toString().includes("Invalid header flag bits")?console.warn("msg",e):console.error("msg",e)}),c.parse(e.data)}),d.send=new Proxy(d.send,{apply(e,r,i){if(!d.url.includes("edge-chat"))return Reflect.apply(e,r,i);const c=n.cfg,s=i[0],a=o.parser(t);a.on("packet",n=>{if("publish"==n.cmd&&"/ls_req"==n.topic){const s=(new TextDecoder).decode(n.payload),d=JSON.parse(s);if(c.blockTyping&&4==d.type){const t=JSON.parse(d.payload),n=JSON.parse(t.payload);if(!n.thread_key)return Reflect.apply(e,r,i);let o=!1;if("blacklist"==c.blockMode?c.blacklist.includes(n.thread_key.toString())&&(o=!0):c.whitelist.includes(n.thread_key.toString())||(o=!0),o)return}if(c.blockSeen&&3==d.type){const s=JSON.parse(d.payload);let a=null;for(const e in s.tasks)if("21"==s.tasks[e].label){const t=JSON.parse(s.tasks[e].payload);a=t.thread_id.toString(),t.last_read_watermark_ts=1e3*Date.now(),s.tasks[e].payload=JSON.stringify(t)}if(a){let l=!1;if("blacklist"==c.blockMode?c.blacklist.includes(a)&&(l=!0):c.whitelist.includes(a)||(l=!0),l)return d.payload=JSON.stringify(s),n.payload=JSON.stringify(d),i[0]=o.generate(n,t),Reflect.apply(e,r,i)}}}return Reflect.apply(e,r,i)}),a.on("error",t=>(console.error("send",t),Reflect.apply(e,r,i))),a.parse(s)}}),d}}),document.addEventListener("DOMContentLoaded",(function(){const e=c("message_threads",!0).find(e=>e.edges),t=c("chat_sidebar_contact_rankings").map(e=>e.user);e&&(n.groups=e.edges.map(e=>e.node).map(e=>({cid:e.thread_key.thread_fbid,name:e.name?e.name:e.all_participants.edges.map(e=>e.node.messaging_actor.short_name).join(", "),img:e.image?e.image.uri:null})).reduce((e,t)=>(e[t.cid]=t,e),{})),t&&(n.users=t.filter(e=>e&&e.id).reduce((e,t)=>(e[t.id]=t,e),{}))}))}var o,r;browser.runtime.onMessage.addListener((n,o)=>e(void 0,void 0,void 0,(function*(){try{const e=JSON.parse(n);e.cfg&&(t.cfg=cloneInto(e.cfg,window))}catch(e){console.error("runtime.msg",e)}}))),browser.runtime.connect(),t.browser=cloneInto(browser,window,{cloneFunctions:!0}),o=document.documentElement,r=e=>{e[0]==document.head&&function(){var e;console.debug("inject"),null===(e=document.getElementById("inject-mqtt"))||void 0===e||e.remove();const t=document.createElement("script");t.id="inject-mqtt",t.src=browser.runtime.getURL("scripts/dist/mqtt.js"),t.onload=()=>{var e,t,o;console.debug("injected mqtt"),null===(e=document.getElementById("inject-script"))||void 0===e||e.remove();const r=document.createElement("script");r.id="inject-script",r.textContent=`!(()=>{${n.toString()};${n.name}();})()`,document.head.insertBefore(r,null!==(o=null===(t=document.head.firstChild)||void 0===t?void 0:t.nextSibling)&&void 0!==o?o:null)},document.head.insertBefore(t,document.head.firstChild)}()},new MutationObserver((function(e){e.forEach((function(e){e.addedNodes.length&&r(e.addedNodes)}))})).observe(o,{childList:!0})}();